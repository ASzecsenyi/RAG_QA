<!doctype html>
<html lang="en">
<head>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>

    <title>RAG QA</title>
    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <style>
        .separator {
            position: relative; /* Needed for absolute positioning of pseudo-elements */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%; /* Full height relative to its columns */
            width: 10px; /* Adjust based on your preference */
            overflow: hidden; /* Ensures pseudo-elements don’t spill out */
        }

        .separator::before,
        .separator::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            background: #dee2e6; /* Use the separator’s background color */
        }

        .separator::before {
            top: 0;
            bottom: 50%; /* Occupy the top half */
            transform: perspective(10px) rotateX(10deg); /* Slight tilt to create top trapezoid half */
            transform-origin: bottom;
        }

        .separator::after {
            top: 50%; /* Occupy the bottom half */
            bottom: 0;
            transform: perspective(10px) rotateX(-10deg); /* Opposite tilt for bottom half */
            transform-origin: top;
        }
        
        .highlighted-component {
            /* give red border */
            border: 2px solid red;
        }

        .button-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 0;
            border-top: 1px solid #dee2e6; /* Adds a subtle border on top for separation */
            text-align: center;
            z-index: 950; /* Ensures it's above most other elements */
        }

        .card-body {
            background-color: #fff; /* Keep the body of the card white for readability */
        }

        .card-wrapper {
            margin-top: 15px;
            position: relative; /* This makes the absolute positioning of the card relative to this wrapper */
            height: auto; /* Initial height of the compact card */
            margin-bottom: 15px; /* Spacing between cards */
        }

        .card.compact .card-body {
            display: none; /* Hide the body initially */
        }

        .card.compact {
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: initial;
            position: relative;
            z-index: 1; /* Ensure it's above base items but below expanded items */
        }

        .card.compact:hover {
            z-index: 1050; /* Bootstrap modal z-index starts at 1050, ensure it's on top */
            position: fixed; /* Ensure it doesn't move other components */  
            height: auto; /* Let it expand to natural height */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Adds a shadow for better focus */
        }

        .card.compact:hover .card-body {
            display: block; /* Show the body on hover */
        }

        .component-title {
            /*padding: 10px; /* Adjust as per your styling needs */
            font-weight: bold;
        }

        @keyframes wobble-animation {
            0% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
            100% { transform: rotate(0deg); }
        }

        .wobble-effect {
            animation: wobble-animation 0.2s ease-in-out;
        }

        .full-span-row {
            display: flex; /* Make this a flex container */
            flex-wrap: nowrap; /* Prevent items from wrapping */
            align-items: center; /* Vertically centers the flex items */
            height: 50vh; /* Adjust based on your design needs */
        }

        #full-span-row .col {
            flex: 1; /* Make each column take up equal space */
            display: flex; /* Make the column itself a flex container */
            flex-direction: column; /* Stack the children vertically */
            justify-content: center; /* Center children vertically in the column */
            overflow: auto; /* Add scrollbars if necessary */
            height: 50vh; /* Adjust based on your design needs */
        }

    </style>
</head>
<body>

{{ initial_data|json_script:"initial-data" }}
{{ answers|json_script:"answers" }}

<div class="container mt-5" style="margin-right: 0; margin-left: 5vw;">
    <div class="row" style="width: 95vw">
        <div class="col">
            <h1>RAG QA</h1>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Display the basic form fields -->
                <div class="mb-3 row-1">
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="alert alert-danger">{{ form.name.errors.as_text }}</div>
                    {% endif %}
                </div>
                <div class="row">
                    {% for class, name in form.cols.items %}
                        <div class="col">
                            <h3>{{ name }}</h3>
                        </div>
                    {% endfor %}
                </div>
                <!-- Container for dynamically added components in columns -->
                <div id="componentsContainer" class="row full-span-row" >
                    {% for class, name in form.cols.items %}
                        <div id="{{ class }}" class="col">
                        </div>
                        {% if not forloop.last %}
                            <div class="separator">x</div>
                        {% else %}
                            <div class="separator">></div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="text-center mt-4 button-container">
                    <!-- Buttons to add new component of each type -->
                    <button type="button" onclick="addTextDocumentComponent()" class="btn btn-info">Add Text Document
                    </button>
                    <button type="button" onclick="addNewsQaDocumentComponent()" class="btn btn-info">Add NewsQA
                        Document
                    </button>
                    <button type="button" onclick="addChunkerComponent()" class="btn btn-info">Add Chunker</button>
                    <button type="button" onclick="addRankerComponent()" class="btn btn-info">Add Ranker</button>
                    <button type="button" onclick="addQAComponent()" class="btn btn-info">Add QA</button>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </form>
        </div>
        <div id="answerCol" class="col">
            <div id="carouselExample" class="carousel slide" data-bs-theme="dark">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <div class="row">
                            <div class="col">
                                <div id="answer" class="container mt-5 component-highlighter" style="overflow-wrap: break-word; overflow-y: scroll; height: 80vh;" data-bs-theme="light">
                                </div>
                            </div>
                            <div class="col-1">
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next" style="width: 7%;">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <div class="row">
                            <div class="col-1">
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev" style="width: 7%">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                            </div>
                            <div class="col">
                                <div id="results" class="container mt-5" style="overflow-wrap: break-word; height: 80vh;" data-bs-theme="light">
                                    <div class="row">
                                        Average over all
                                        <div class="col">
                                            <div class="form-check">
                                                <input class="form-check-input agg-res-updater" type="checkbox" value="" id="ChunkerCheck">
                                                <label class="form-check-label" for="ChunkerCheck">
                                                  Chunkers
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-check">
                                                <input class="form-check-input agg-res-updater" type="checkbox" value="" id="RankerCheck">
                                                <label class="form-check-label" for="RankerCheck">
                                                  Rankers
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-check">
                                                <input class="form-check-input agg-res-updater" type="checkbox" value="" id="QACheck">
                                                <label class="form-check-label" for="QACheck">
                                                  QAs
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-check">
                                                <input class="form-check-input agg-res-updater document-aggr-res-updater" type="checkbox" value="" id="DocumentCheck">
                                                <label class="form-check-label" for="DocumentCheck">
                                                  Documents
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h5>Aggregated results</h5>
                                        </div>
                                        <div class="card-body" id="aggrDisplay">
                                            <p>Aggregated results will be displayed here.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    // <!-- initialise with the value of the number input num_text_documents -->
    let TextDocumentIndexCount = 0;
    let NewsQaDocumentIndexCount = 0;
    let ChunkerIndexCount = 0;
    let RankerIndexCount = 0;
    let QAIndexCount = 0;

    // <!-- TODO: get these from form -->
    let defaultValues = {
        Chunker: {
            CharChunker: {
                chunk_length: 200,
                sliding_window_size: 0.1,
                chunker_name: "char_chunker_"
            },
            WordChunker: {
                chunk_length: 50,
                sliding_window_size: 0.1,
                chunker_name: "word_chunker_"
            },
            SentChunker: {
                chunk_length: 2,
                sliding_window_size: 0.5,
                chunker_name: "sent_chunker_"
            }
        },
        Ranker: {
            TfidfRanker: {
                top_k: 4,
                ranker_name: "tfidf_ranker_"
            },
            SentEmbeddingRanker: {
                top_k: 5,
                ranker_name: "sent_embedding_ranker_"
            },
            CrossEncodingRanker: {
                top_k: 5,
                ranker_name: "cross_encoding_ranker_"
            },
            GuessSimilarityRanker: {
                top_k: 3,
                ranker_name: "guess_similarity_ranker_"
            },
            HybridRanker: {
                top_k: 4,
                ranker_name: "hybrid_ranker_"
            },
            PromptRanker: {
                top_k: 3,
                ranker_name: "prompt_ranker_"
            }
        },
        QA: {
            MistralQA: {
                model_name: "mistral_qa_"
            },
            GptQA: {
                model_name: "gpt_qa_"
            },
            LlamaQA: {
                model_name: "llama_qa_"
            },
            GemmaQA: {
                model_name: "gemma_qa_"
            }    
        },
        NewsQaDocument: {
            NewsQaDocument: {
                num_of_stories: 150,
                newsqa_name: "newsqa"
            },
            QAsperDocument: {
                num_of_stories: 150,
                newsqa_name: "qasper"
            }
        }
    };

    let customValues = {
        Chunker: {},
        Ranker: {},
        QA: {},
        NewsQaDocument: {}
    };
    let currentPipeline = [];

    function addTextDocumentComponent(componentData = null) {
        let fileName = componentData ? componentData.fileName : '';
        let file_path = componentData ? componentData.file_path : '';
        let question = componentData ? componentData.question : '';
        let textdoc_name = componentData ? componentData.textdoc_name : `textdoc_${TextDocumentIndexCount}`;

        const html = `
            <div class="card-wrapper ExperimentTextDocument">
                <div class="card compact">
                    <div class="card-header component-title">Text ${TextDocumentIndexCount + 1}</div>
                    <div class="card-body">
                        <div class="form-floating mb-3">
                            <input type="file" name="ExperimentTextDocument_file_${TextDocumentIndexCount}" id="ExperimentTextDocument_file_${TextDocumentIndexCount}" class="form-control mb-2 saveable-input" accept=".txt" value="${fileName}">
                            <label for="ExperimentTextDocument_file_${TextDocumentIndexCount}">File</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" name="ExperimentTextDocument_file_path_${TextDocumentIndexCount}" id="ExperimentTextDocument_file_path_${TextDocumentIndexCount}" class="form-control mb-2 saveable-input" value="${file_path}">
                            <label for="ExperimentTextDocument_file_path_${TextDocumentIndexCount}">File Path</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" name="ExperimentTextDocument_question_${TextDocumentIndexCount}" id="ExperimentTextDocument_question_${TextDocumentIndexCount}" class="form-control mb-2 saveable-input" value="${question}">
                            <label for="ExperimentTextDocument_question_${TextDocumentIndexCount}">Question</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" name="ExperimentTextDocument_textdoc_name_${TextDocumentIndexCount}" id="ExperimentTextDocument_textdoc_name_${TextDocumentIndexCount}" class="form-control mb-2 saveable-input" value="${textdoc_name}">
                            <label for="ExperimentTextDocument_textdoc_name_${TextDocumentIndexCount}">Text Document Name</label>
                        </div>
                        <input type="checkbox" class="${ componentData == null ? 'deletable-component' : ''} form-check-input mb-2" name="delete_ExperimentTextDocument_${TextDocumentIndexCount}" value="delete"> Delete
                    </div>
                </div>
            </div>
        `;
        $('#ExperimentTextDocument').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        TextDocumentIndexCount++;
    }

    function addNewsQaDocumentComponent(componentData = null) {
        let newsqa_type = componentData ? componentData.newsqa_type : 'NewsQaDocument';
        let num_of_stories = componentData ? componentData.num_of_stories : 150;
        let newsqa_name = componentData ? componentData.newsqa_name : `newsqa`;

        const html = `
    <div class="card-wrapper ExperimentTextDocument">
        <div class="card compact">
            <div class="card-header component-title">NewsQA ${NewsQaDocumentIndexCount + 1}</div>
            <div class="card-body">
                <div class="form-floating mb-3">
                    <select name="ExperimentNewsQaDocument_newsqa_type_${NewsQaDocumentIndexCount}" id="ExperimentNewsQaDocument_newsqa_type_${NewsQaDocumentIndexCount}" class="form-select mb-2 saveable-input">
                        <option value="NewsQaDocument" ${newsqa_type==='NewsQaDocument' ? 'selected=""' : '' }>NewsQaDocument</option>
                        <option value="QAsperDocument" ${newsqa_type==='QAsperDocument' ? 'selected=""' : '' }>QAsperDocument</option>
                    </select>
                    <label for="ExperimentNewsQaDocument_newsqa_type_${NewsQaDocumentIndexCount}">Document Type</label>
                </div>
                <label for="ExperimentNewsQaDocument_num_of_stories_${NewsQaDocumentIndexCount}">Num of Stories</label>
                <input type="range" name="ExperimentNewsQaDocument_num_of_stories_${NewsQaDocumentIndexCount}" id="ExperimentNewsQaDocument_num_of_stories_${NewsQaDocumentIndexCount}" class="form-range" min="0" max="200" value="${num_of_stories}"  oninput="this.nextElementSibling.value = this.value">
                <output>${num_of_stories}</output>
                <div class="form-floating mb-3">
                    <input type="text" name="ExperimentNewsQaDocument_newsqa_name_${NewsQaDocumentIndexCount}" id="ExperimentNewsQaDocument_newsqa_name_${NewsQaDocumentIndexCount}" class="form-control mb-2 saveable-input" value="${newsqa_name}">
                    <label for="ExperimentNewsQaDocument_newsqa_name_${NewsQaDocumentIndexCount}">NewsQA Name</label>
                </div>
                <input type="checkbox" class="${ componentData == null ? 'deletable-component' : ''} form-check-input mb-2" name="delete_ExperimentTextDocument_${NewsQaDocumentIndexCount}" value="delete"> Delete
            </div>
        </div>
    </div>
  `;
        $('#ExperimentTextDocument').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        NewsQaDocumentIndexCount++;
    }

    function addChunkerComponent(componentData = null) {
        let chunker_type = componentData ? componentData.chunker_type : 'CharChunker';
        let chunk_length = componentData ? componentData.chunk_length : 200;
        let sliding_window_size = componentData ? componentData.sliding_window_size : 0.1;
        let chunker_name = componentData ? componentData.chunker_name : `chunker_${ChunkerIndexCount}`;

        // TODO get select options from form
        const html = `
    <div class="card-wrapper ExperimentChunker">
        <div class="card compact">
            <div class="card-header component-title">${chunker_type} ${ChunkerIndexCount + 1}</div>
            <div class="card-body">
                <div class="form-floating mb-3">
                    <select name="ExperimentChunker_chunker_type_${ChunkerIndexCount}" id="ExperimentChunker_chunker_type_${ChunkerIndexCount}" class="form-select mb-2 saveable-input">
                        <option value="CharChunker" ${chunker_type==='CharChunker' ? 'selected=""' : '' }>CharChunker</option>
                        <option value="WordChunker" ${chunker_type==='WordChunker' ? 'selected=""' : '' }>WordChunker</option>
                        <option value="SentChunker" ${chunker_type==='SentChunker' ? 'selected=""' : '' }>SentChunker</option>
                    </select>
                    <label for="ExperimentChunker_chunker_type_${ChunkerIndexCount}">Chunker Type</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="number" name="ExperimentChunker_chunk_length_${ChunkerIndexCount}" id="ExperimentChunker_chunk_length_${ChunkerIndexCount}" class="form-control mb-2 saveable-input" value="${chunk_length}">
                    <label for="ExperimentChunker_chunk_length_${ChunkerIndexCount}">Chunk Length</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="number" name="ExperimentChunker_sliding_window_size_${ChunkerIndexCount}" id="ExperimentChunker_sliding_window_size_${ChunkerIndexCount}" class="form-control mb-2 saveable-input" value="${sliding_window_size}">
                    <label for="ExperimentChunker_sliding_window_size_${ChunkerIndexCount}">Sliding Window Size</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="ExperimentChunker_chunker_name_${ChunkerIndexCount}" id="ExperimentChunker_chunker_name_${ChunkerIndexCount}" class="form-control mb-2 saveable-input" value="${chunker_name}">
                    <label for="ExperimentChunker_chunker_name_${ChunkerIndexCount}">Chunker Name</label>
                </div>
                <input type="checkbox" class="${ componentData == null ? 'deletable-component' : ''} form-check-input mb-2" name="delete_ExperimentChunker_${ChunkerIndexCount}" value="delete"> Delete
            </div>
        </div>
    </div>
  `;
        $('#ExperimentChunker').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        ChunkerIndexCount++;
    }

    function addRankerComponent(componentData = null) {
        let ranker_type = componentData ? componentData.ranker_type : 'TfidfRanker';
        let top_k = componentData ? componentData.top_k : 4;
        let ranker_name = componentData ? componentData.ranker_name : `ranker_${RankerIndexCount}`;

        // TODO get select options from form    
        const html = `
    <div class="card-wrapper ExperimentRanker">
        <div class="card compact">
            <div class="card-header component-title">${ranker_type} ${RankerIndexCount + 1}</div>
            <div class="card-body">
                <div class="form-floating mb-3">
                    <select name="ExperimentRanker_ranker_type_${RankerIndexCount}" id="ExperimentRanker_ranker_type_${RankerIndexCount}" class="form-select mb-2 saveable-input">
                        <option value="TfidfRanker" ${ranker_type==='TfidfRanker' ? 'selected=""' : '' }>TfidfRanker</option>
                        <option value="SentEmbeddingRanker" ${ranker_type==='SentEmbeddingRanker' ? 'selected=""' : '' }>SentEmbeddingRanker</option>
                        <option value="CrossEncodingRanker" ${ranker_type==='CrossEncodingRanker' ? 'selected=""' : '' }>CrossEncodingRanker</option>
                        <option value="GuessSimilarityRanker" ${ranker_type==='GuessSimilarityRanker' ? 'selected=""' : '' }>GuessSimilarityRanker</option>
                        <option value="HybridRanker" ${ranker_type==='HybridRanker' ? 'selected=""' : '' }>HybridRanker</option>
                        <option value="PromptRanker" ${ranker_type==='PromptRanker' ? 'selected=""' : '' }>PromptRanker</option>
                    </select>
                    <label for="ExperimentRanker_ranker_type_${RankerIndexCount}">Ranker Type</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="number" name="ExperimentRanker_top_k_${RankerIndexCount}" id="ExperimentRanker_top_k_${RankerIndexCount}" class="form-control mb-2 saveable-input" value="${top_k}">
                    <label for="ExperimentRanker_top_k_${RankerIndexCount}">Top K</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="ExperimentRanker_ranker_name_${RankerIndexCount}" id="ExperimentRanker_ranker_name_${RankerIndexCount}" class="form-control mb-2 saveable-input" value="${ranker_name}">
                    <label for="ExperimentRanker_ranker_name_${RankerIndexCount}">Ranker Name</label>
                </div>
                <input type="checkbox" class="${ componentData == null ? 'deletable-component' : ''} form-check-input mb-2" name="delete_ExperimentRanker_${RankerIndexCount}" value="delete"> Delete
            </div>
        </div>
    </div>
  `;
        $('#ExperimentRanker').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        RankerIndexCount++;
    }

    function addQAComponent(componentData = null) {
        let model_type = componentData ? componentData.model_type : 'MistralQA';
        let model_name = componentData ? componentData.model_name : `qa_${QAIndexCount}`;

        // TODO get select options from form 
        const html = `
    <div class="card-wrapper ExperimentQA">
        <div class="card compact">
            <div class="card-header component-title">${model_type} ${QAIndexCount + 1}</div>
            <div class="card-body">
                <div class="form-floating mb-3">
                    <select name="ExperimentQA_model_type_${QAIndexCount}" id="ExperimentQA_model_type_${QAIndexCount}" class="form-select mb-2 saveable-input">
                        <option value="MistralQA" ${model_type==='MistralQA' ? 'selected=""' : '' }>MistralQA</option>
                        <option value="GptQA" ${model_type==='GptQA' ? 'selected=""' : '' }>GptQA</option>
                        <option value="LlamaQA" ${model_type==='LlamaQA' ? 'selected=""' : '' }>LlamaQA</option>
                        <option value="GemmaQA" ${model_type==='GemmaQA' ? 'selected=""' : '' }>GemmaQA</option>
                    </select>
                    <label for="ExperimentQA_model_type_${QAIndexCount}">Model Type</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="ExperimentQA_model_name_${QAIndexCount}" id="ExperimentQA_model_name_${QAIndexCount}" class="form-control mb-2 saveable-input" value="${model_name}">
                    <label for="ExperimentQA_model_name_${QAIndexCount}">Model Name</label>
                </div>
                <input type="checkbox" class="${ componentData == null ? 'deletable-component' : ''} form-check-input mb-2" name="delete_ExperimentQA_${QAIndexCount}" value="delete"> Delete
            </div>
        </div>
    </div>
  `;
        $('#ExperimentQA').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        QAIndexCount++;
    }

    function deleteComponent() {
        $(this).closest('.card-wrapper').remove();
    }

    function updateAggrResults() {
        // get the results for the current pipeline from the answers dictionary
        const results = JSON.parse(document.getElementById('answers').textContent);
        let aggrResultsDiv = document.getElementById('results');
        // check which checkboxes are checked, create an array of 0s and 1s
        let checked = Array.from(aggrResultsDiv.querySelectorAll('input[type="checkbox"]')).map(checkbox => checkbox.checked ? (checkbox.interPersist ? -1 : 0) : 1);
        // find all results that match the currentPipeline in their elements that have a 1 in the checked array
        let matchingResults = Object.keys(results).filter(key => {
            let keyComponents = key.split('<sep>');
            // e.g. if checked is [1, 0, 1, 0]
            // and keyComponents is ['chunker_0', 'ranker_0', 'qa_0', 'newsqa_0']
            // then we want to return true if keyComponents[0] and keyComponents[2] are in the currentPipeline
            // and we do not care whether keyComponents[1] and keyComponents[3] are in the currentPipeline.
            return keyComponents.every((component, index) => {
                return (checked[index] === 1 && currentPipeline.includes(component)) || checked[index] < 1;
            });
        });
        // if the last checkbox has value -1, we want macro aggregation for the documents
        // group the matchingResults by the document name and calculate the average of the metrics for each document
        let aggrResults = {};
        if (checked[checked.length - 1] === -1) {
            let documentResults = {};
            matchingResults.forEach(key => {
                let keyComponents = key.split('<sep>');
                let documentName = keyComponents[3];
                // if all the results have no ground truth, we do not want to include them in the aggregation
                let pipeline = results[key];
                let allNoGroundTruth = pipeline.every(val => val.ground_truths.length === 1 && val.ground_truths[0] === '');
                if (allNoGroundTruth) {
                    return;
                }
                if (documentResults[documentName] === undefined) {
                    documentResults[documentName] = [];
                }
                documentResults[documentName].push(key);
            });
            // calculate the average of the metrics for each document
            for (const [document, document_pipelines_list] of Object.entries(documentResults)) {
                let aggrResultsForDocument = {};
                let count = 0;
                document_pipelines_list.forEach(pipeline => {
                    let pipeline_results = results[pipeline];
                    pipeline_results.forEach((eval, index) => {
                        count++;
                        for (const [key, value] of Object.entries(eval)) {
                            if (typeof value === 'number') {
                                if (aggrResultsForDocument[key] === undefined) {
                                    aggrResultsForDocument[key] = 0;
                                }
                                aggrResultsForDocument[key] += value;
                            }
                        }
                    });
                });
                // divide each value in aggrResultsForDocument by count
                for (const [key, value] of Object.entries(aggrResultsForDocument)) {
                    aggrResultsForDocument[key] = value / count;
                }
                aggrResults[document] = aggrResultsForDocument;
            }
        } else {
            // if the last checkbox has value 1, we want micro aggregation for the documents
            matchingResults.forEach(pipeline => {
                let pipeline_results = results[pipeline];
                pipeline_results.forEach((eval, index) => {
                    // if value has a ground truth
                    if (eval.ground_truths.length === 1 && eval.ground_truths[0] === '') {
                        return;
                    }
                    let qResults = {};
                    for (const [key, value] of Object.entries(eval)) {
                        if (typeof value === 'number') {
                            qResults[key] = value;
                        }
                    }
                    aggrResults[pipeline+index] = qResults;
                });
            });
        }

        // Calculate the aggregated mean results for all numerical values in the matchingResults
        let aggrResultsFinal = {};
        let count = 0;
        for (const [key, value] of Object.entries(aggrResults)) {
            count++;
            for (const [key_, value_] of Object.entries(value)) {
                if (typeof value_ === 'number') {
                    if (aggrResultsFinal[key_] === undefined) {
                        aggrResultsFinal[key_] = 0;
                    }
                    aggrResultsFinal[key_] += value_;
                }
            }
        }
        // divide each value in aggrResults by count
        for (const [key, value] of Object.entries(aggrResultsFinal)) {
            aggrResultsFinal[key] = value / count;
        }

        // display the aggrResults in the aggrResultsDiv
        let aggrDisplay = document.getElementById('aggrDisplay');
        aggrDisplay.innerHTML = '';
        if (Object.keys(aggrResultsFinal).length === 0) {
            let p = document.createElement('p');
            p.innerHTML = `No results to display.`;
            aggrDisplay.appendChild(p);
        }
        for (const [key, value] of Object.entries(aggrResultsFinal)) {
            let p = document.createElement('p');
            p.innerHTML = `<strong>${key}:</strong> ${value}`;
            aggrDisplay.appendChild(p);
        }
    }

    const names = ['chunker_name', 'ranker_name', 'model_name', 'textdoc_name', 'newsqa_name', ];

    function updateHighlights(newElement) {
        // update the highlights based on the newElement
        let newElementId = newElement[0].id;
        let newComponents = newElementId.split('<sep>');
        // iterate through the components and highlight them - find the component whose name is in the components list and add the class highlighted
        newComponents.forEach((component) => {
            // find the component whose name is in the components list
            // iterate through the names list and look at all the text inputs whose name contains the component name
            // if the value of the text input is the same as the component name, then add the class highlighted
            names.forEach((name) => {
                let componentWrapper = $(`input[name*="${name}"]`).filter(function() {
                    if (this.value === 'newsqa' || this.value === 'qasper') {
                        return component.startsWith(this.value);
                    }
                    return this.value === component;
                }).closest('.card');
                componentWrapper.addClass('highlighted-component');

                // remove the class highlighted from all the other components in the same column
                componentWrapper.closest('.col').find('.card').not(componentWrapper).removeClass('highlighted-component');
            });
        });
        currentPipeline = newComponents;
        updateAggrResults();
    }

    function updateInputValues(comp, compType, selectedValue, index) {
        comp.fields.forEach(field => {
            let inputName = `${comp.prefix}_${field}_${index}`;
            let input = $(`input[name="${inputName}"]`);
            let newValue = defaultValues[compType][selectedValue][field];

            if (field.includes('_name')) {
                newValue += index;
            }

            if (!customValues[compType][index][selectedValue] || !customValues[compType][index][selectedValue][field]) {
                input.val(newValue);
            } else {
                input.val(customValues[compType][index][selectedValue][field]);
            }
        });
    }



    // read initial data about components and answers
    document.addEventListener("DOMContentLoaded", function() {
        const initialData = JSON.parse(document.getElementById('initial-data').textContent)['components'];
        console.log(initialData);
        initialData.forEach(component => {
            switch(component.type) {
                    case 'ExperimentTextDocument':
    
                        addTextDocumentComponent(component.data);
                        break;
    
                    case 'ExperimentNewsQaDocument':
                        addNewsQaDocumentComponent(component.data);
                        break;
    
                    case 'ExperimentChunker':
                        addChunkerComponent(component.data);
                        break;
    
                    case 'ExperimentRanker':
                        addRankerComponent(component.data);
                        break;
    
                    case 'ExperimentQA':
                        addQAComponent(component.data);
                        break;
                }
        });


        const answers = JSON.parse(document.getElementById('answers').textContent);
        console.log(answers);
        // answers is a dictionary with the keys being the set of component instances (i.e. pipelines) and the values being the list of answers
        // iterate through the dictionary and display the answers
        for (const [key, value] of Object.entries(answers)) {
            let answerDiv = document.getElementById('answer');
            let answer = document.createElement('div');
            // id the answer div with the key
            // key looks like chunker_0<sep>ranker_0<sep>qa_0<sep>newsqa_0
            answer.id = key;
            // add class component-highlighter-element
            answer.className = 'component-highlighter-element';
            value.forEach((val, index) => {
                // val is a dict, we want the keys question, answer, ground_truths, contexts and fmeasure
                
                let html = `
                    <div class="card mb-3" data-bs-toggle="collapse" href="#collapseExample-${key}-${index}" role="button">
                        <div class="card-header">
                            <h5>Question ${index + 1}</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Question:</strong> ${val.question}</p>
                            <p><strong>Answer:</strong> ${val.answer.replace(val.ground_truths, `<strong>${val.ground_truths}</strong>`)}</p>
                            <p><strong>Ground Truths:</strong> <strong>${val.ground_truths}</strong></p>
                            <div class="collapse" id="collapseExample-${key}-${index}">
                                <p><strong>Contexts:</strong> ${val.contexts.map(context => context.replace(val.ground_truths, `<strong>${val.ground_truths}</strong>`)).join('<br>')}</p>
                                <p><strong>Precision:</strong> ${val.precision}</p>
                                <p><strong>Recall:</strong> ${val.recall}</p>
                                <p><strong>F-Measure:</strong> ${val.fmeasure}</p>
                            </div>
                        </div>
                    </div>
                `;
                // if ground_truths is empty (i.e. it is a list of length 1 with an empty string element), 
                // then we don't want to display it or the metrics
                if (val.ground_truths.length === 1 && val.ground_truths[0] === '') {
                    html = `
                        <div class="card mb-3"  data-bs-toggle="collapse" href="#collapseExample-${key}-${index}" role="button">
                            <div class="card-header">
                                <h5>Question ${index + 1}</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Question:</strong> ${val.question}</p>
                                <p><strong>Answer:</strong> ${val.answer}</p>
                                <div class="collapse" id="collapseExample-${key}-${index}">
                                    <p><strong>Contexts:</strong> ${val.contexts.join('<br>')}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                answer.innerHTML += html;
            });
            answerDiv.appendChild(answer);
        }
        
    });

    $(document).ready(function () {
        let componentHighlighter = $('.component-highlighter');
        let componentHighlighterElements = componentHighlighter.find('.component-highlighter-element');
        let currentElement = componentHighlighterElements.filter(function() {
            let rect = this.getBoundingClientRect();
            return (
                rect.top <= componentHighlighter.height()
                && rect.bottom >= 0
            );
        });
        // if the currentElement is not empty, then we have an element in view
        if (currentElement.length) {
            // get the components whose names are in the currentElementId
            updateHighlights(currentElement);
        }

        var answerCol = document.getElementById('answerCol');
        var textContent = answerCol.textContent || answerCol.innerText;
        textContent = textContent.trim();

        if (!textContent) {
            /* change answerDiv class to col-3 */
            answerCol.className = 'col-3';
        }
        
        // Make form name pretty
        $('input[type="text"]').addClass('form-control mb-2');


        $('#componentsContainer .col').each(function() {
            $(this).sortable({
                items: ".card-wrapper",
                axis: 'y',
                containment: 'parent',
                cursor: 'move',
                opacity: 0.6,
                helper: function(e, ui) {
                    // Create a clone of the element being dragged
                    var clone = ui.clone();
                    clone.css('position', 'absolute');
                    return clone.get(0);
                },
            }).disableSelection();
        });

        // update the aggregate results when the checkboxes are clicked
        $(document).on('change', '.agg-res-updater', function(e) {
            // if the checkbox has class document-aggr-res-updater
            if ($(e.target).hasClass('document-aggr-res-updater')) {
                // if the checkbox clicked was previously unchecked, set it to intermediate state
                if ($(e.target).prop('checked') === true && $(e.target).prop('interPersist') === false) {
                    $(e.target).prop({
                        indeterminate: true,
                        interPersist: true,
                        checked: true
                    });
                }
                // if the checkbox clicked was previously in intermediate state, set it to checked
                else if ($(e.target).prop('checked') === false && $(e.target).prop('interPersist') === true){
                    $(e.target).prop({
                        indeterminate: false,
                        interPersist: false,
                        checked: true
                    });
                }
                // if the checkbox clicked was previously checked, set it to unchecked
                else if ($(e.target).prop('checked') === false && $(e.target).prop('interPersist') === false) {
                    $(e.target).prop({
                        indeterminate: false,
                        interPersist: false,
                        checked: false
                    });
                } else {
                    $(e.target).prop({
                        indeterminate: true,
                        interPersist: true,
                        checked: true
                    });
                }
            }

            updateAggrResults();
        });

        // update the component-highlighter-element that is currently in view based on the clicked .card
        $(document).on('click', '.card', function() {
            // iterate through the names list and look at the text input that is in the card
            // set the value of currentName to the value of the text input
            let currentName = '';
            names.forEach((name) => {
                let input = $(this).find(`input[name*="${name}"]`);
                if (input.length) {
                    currentName = input.val();
                }
            });
            // if the clicked cards name is not in the components list
            // scroll to the component-highlighter-element whose id contains the name of the clicked card but is otherwise the same as the currentElementId
            if (!currentPipeline.includes(currentName)) {
                let extendedComponents = currentPipeline.concat(currentName);
                let newElement = componentHighlighterElements.filter(function() {
                    // return the one that has 4 out of the five elements in components+currentName, incl. currentName
                    let id = this.id;
                    let idComponents = id.split('<sep>');
                    let count = 0;
                    for (let i = 0; i < extendedComponents.length; i++) {
                        if (idComponents.includes(extendedComponents[i])) {
                            count++;
                        }
                    }
                    return count === 4 && idComponents.includes(currentName);
                });
                if (newElement.length) {
                    newElement[0].scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"});
                    updateHighlights(newElement);
                }
            } else {
                let newElement = componentHighlighterElements.filter(function() {
                    return this.id.split('<sep>') === currentPipeline;
                });
                if (newElement.length) {
                    newElement[0].scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"});
                    updateHighlights(newElement);
                }
            }
        });


        // update the highlights based on the component-highlighter-element that is currently in view
        $(document).on('wheel', '.component-highlighter', function(e) {    
            // find the component-highlighter-element that is currently in view
            let componentHighlighter = $(this);
            let componentHighlighterElements = componentHighlighter.find('.component-highlighter-element');
            let scrollDistanceIfDown = e.originalEvent.deltaY > 0 ? e.originalEvent.deltaY : 0;
            let currentElement = componentHighlighterElements.filter(function() {
                let rect = this.getBoundingClientRect();
                return (
                    rect.top <= componentHighlighter.height()
                    && rect.bottom >= 0
                    && rect.bottom >= componentHighlighter.offset().top + scrollDistanceIfDown
                );
            });

            // if the currentElement is not empty, then we have an element in view
            if (currentElement.length) {
                let rect = currentElement[0].getBoundingClientRect();
                console.log('bottom', rect.bottom);
                console.log('top', rect.top);
                console.log('height', componentHighlighter.height());
                console.log('offsetTop', componentHighlighter.offset().top);
                updateHighlights(currentElement);
            }
        });

        // Below is the code to handle the scrolling of the components
        $(document).on('wheel', '.card', function(e) {
              // Find the select element within the card
              let select = $(this).find('.form-select');

              // If there's no select element, don't do anything
              if (select.length === 0) {
                return;
              }

              let selectedIndex = select.prop('selectedIndex');
              let scrollDirection = e.originalEvent.deltaY;

              if (scrollDirection < 0) {
                  // Scroll up
                  if (selectedIndex > 0) {
                      select.prop('selectedIndex', selectedIndex - 1).change();
                  }
              } else {
                  // Scroll down
                  if (selectedIndex < select.children('option').length - 1) {
                      select.prop('selectedIndex', selectedIndex + 1).change();
                  }
              }

              // if reached the end of the options, jump back to the first option
              if (selectedIndex === select.children('option').length - 1 && scrollDirection > 0) {
                  select.prop('selectedIndex', 0).change();
              }

              // if reached the start of the options, jump back to the last option
              if (selectedIndex === 0 && scrollDirection < 0) {
                  select.prop('selectedIndex', select.children('option').length - 1).change();
              }

              // change the card name to the selected option + current index
                let cardHeader = $(this).find('.card-header');
                let selectedValue = select.val();
                cardHeader.text(`${selectedValue} ${cardHeader.text().split(' ')[1]}`);
          });

        $(document).on('change', '.form-select', function() {
            let select = $(this);
            let selectedValue = select.val();
            let index = select.attr('name').match(/\d+$/)[0];

            const componentMapping = {
                Chunker: {
                    match: select.attr('name').match(/Chunker_(.+)_\d+/),
                    fields: ['chunk_length', 'sliding_window_size', 'chunker_name'],
                    prefix: 'ExperimentChunker',
                },
                Ranker: {
                    match: select.attr('name').match(/Ranker_(.+)_\d+/),
                    fields: ['top_k', 'ranker_name'],
                    prefix: 'ExperimentRanker',
                },
                QA: {
                    match: select.attr('name').match(/QA_(.+)_\d+/),
                    fields: ['model_name'],
                    prefix: 'ExperimentQA',
                },
                NewsQaDocument: {
                    match: select.attr('name').match(/NewsQaDocument_(.+)_\d+/),
                    fields: ['num_of_stories', 'newsqa_name'],
                    prefix: 'ExperimentNewsQaDocument', 
                },
            };

            Object.keys(componentMapping).forEach((compType) => {
                let comp = componentMapping[compType];
                if (comp.match && comp.match[1] === compType.toLowerCase() + '_type') {
                    if (!customValues[compType][index]) {
                        customValues[compType][index] = {};
                    }

                    updateInputValues(comp, compType, selectedValue, index);
                }
            });

            let parentCard = $(this).closest('.card');

            // Add the 'wobble-effect' class to trigger the animation
            parentCard.addClass('wobble-effect');

            // Listen for the end of the animation and then remove the class
            parentCard.on('animationend', function() {
                parentCard.removeClass('wobble-effect');
            });
        });

        $(document).on('input', '.saveable-input', function() {
            let input = $(this);
            let inputName = input.attr('name');
            let index = inputName.match(/\d+$/)[0];

            const componentDetails = [
                { type: 'Chunker', regex: /(ExperimentChunker)_(.+)_\d+$/ },
                { type: 'Ranker', regex: /(ExperimentRanker)_(.+)_\d+$/ },
                { type: 'QA', regex: /(ExperimentQA)_(.+)_\d+$/ },
                { type: 'NewsQaDocument', regex: /(ExperimentNewsQaDocument)_(.+)_\d+$/ },
            ];

            componentDetails.forEach((compDetail) => {
                let match = inputName.match(compDetail.regex);
                if (match) {
                    let fieldType = match[2];
                    let compType = match[1].split('Experiment')[1];
                    let selector = $(`select[name="${compDetail.type}_${compType.toLowerCase()}_type_${index}"]`).val();

                    if (!customValues[compDetail.type][index]) {
                        customValues[compDetail.type][index] = {};
                    }

                    if (!customValues[compDetail.type][index][selector]) {
                        customValues[compDetail.type][index][selector] = {};
                    }

                    customValues[compDetail.type][index][selector][fieldType] = input.val();
                }
            });
        });

        // Store the original width of each .card.compact in a data attribute
        $('.card-wrapper').each(function() {
            const originalWidth = $(this).width();
            const originalHeight = $(this).height();
            $(this).data('originalWidth', originalWidth);
            $(this).data('originalHeight', originalHeight);
        });
        
        $('.card-wrapper').hover(
            function() {
                // On mouse in, get original width of .card.compact from data attribute
                var originalWidth = $(this).data('originalWidth');
                var originalHeight = $(this).data('originalHeight');
                // Set the width of .card-wrapper to the original width of .card.compact
                $(this).css('width', originalWidth);
                $(this).css('height', originalHeight);
            },
            function() {
                // On mouse out, reset the width of .card-wrapper
                $(this).css('width', '');
                $(this).css('height', '');
                // update the original width of .card.compact from the current width of .card-wrapper
                $(this).data('originalWidth', $(this).width());
                $(this).data('originalHeight', $(this).height());
            }
        );


    });
</script>

</body>
</html>