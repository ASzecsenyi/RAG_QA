<!doctype html>
<html lang="en">
<head>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <title>RAG QA</title>
    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        .button-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 0;
            background-color: #f8f9fa; /* Light gray background, or choose your own */
            border-top: 1px solid #dee2e6; /* Adds a subtle border on top for separation */
            text-align: center;
            z-index: 1000; /* Ensures it's above most other elements */
        }

        .container {
            padding-bottom: 100px; /* Adjust this value based on your button container's height to ensure it doesn't overlap content */
        }

        .card-wrapper {
            position: relative; /* This makes the absolute positioning of the card relative to this wrapper */
            height: 50px; /* Initial height of the compact card */
        }

        .card.compact .card-body {
            display: none; /* Hide the body initially */
        }

        .card.compact {
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: initial;
            z-index: 1; /* Ensure it's above base items but below expanded items */
        }

        .card.compact:hover {
            z-index: 1050; /* Bootstrap modal z-index starts at 1050, ensure it's on top */
            position: fixed; /* Ensure it doesn't move other components */
            height: auto; /* Let it expand to natural height */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Adds a shadow for better focus */
        }

        .card.compact:hover ~ * {
            filter: blur(4px); /* Adjust blur as necessary */
        }

        .container:hover {
            filter: none;
        }

        .container * {
            transition: filter 0.3s ease;
        }

        .card.compact:hover .card-body {
            display: block; /* Show the body on hover */
        }

        .component-title {
            padding: 10px; /* Adjust as per your styling needs */
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1>RAG QA</h1>
    <div class="row">
        <div class="col">

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Display the basic form fields -->
                <div class="mb-3">
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="alert alert-danger">{{ form.name.errors.as_text }}</div>
                    {% endif %}
                </div>

                <!-- Container for dynamically added components in columns -->
                <div id="componentsContainer" class="row">
                    {% for class, components in grouped_fields.items %}
                        <div id="{{ class }}" class="col">
                            <h3>{{ class|slice:"10:" }}</h3>
                            <!-- Dynamically render existing components -->
                            {% for component in components %}
                                <div class="card-wrapper">
                                    <div class="card mb-3 compact">
                                        <div class="card-header component-title">{{ class }}</div>
                                        <div class="card-body">
                                            {% for field_name, field in component.fields %}
                                                <div class="form-group
                                    {% if field.errors %} has-error{% endif %}">
                                                    {% for field in form %}
                                                        {% if field_name in field.name %}
                                                            {{ field.errors }}
                                                            {{ field.label }}{{ field }} {% if 'delete' in field.name %}Delete{% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <div class="text-center mt-4 button-container">
                    <!-- Buttons to add new component of each type -->
                    <button type="button" onclick="addTextDocumentComponent()" class="btn btn-info">Add Text Document
                    </button>
                    <button type="button" onclick="addNewsQADocumentComponent()" class="btn btn-info">Add NewsQA
                        Document
                    </button>
                    <button type="button" onclick="addChunkerComponent()" class="btn btn-info">Add Chunker</button>
                    <button type="button" onclick="addRankerComponent()" class="btn btn-info">Add Ranker</button>
                    <button type="button" onclick="addQAComponent()" class="btn btn-info">Add QA</button>

                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </form>
        </div>

        <div class="col-3">
            <div id="answer" class="container mt-5">
                <!-- if the answer is not the empty string: -->
                {% if answer %}
                    <h2>Answer:</h2>
                    <p>{{ answer }}</p>
                    <h2>Context:</h2>
                    <p>{{ context }}</p>
                {% endif %}
            </div>
        </div>

    </div>

</div>

<script>
    <!-- initialise with the value of the number input num_text_documents -->
    let TextDocumentIndexCount = {{ form.id_dict.ExperimentTextDocument|length }};
    let NewsQADocumentIndexCount = {{ form.id_dict.ExperimentNewsQADocument|length }};
    let ChunkerIndexCount = {{ form.id_dict.ExperimentChunker|length }};
    let RankerIndexCount = {{ form.id_dict.ExperimentRanker|length }};
    let QAIndexCount = {{ form.id_dict.ExperimentQA|length }};
    
    let defaultValues = {
        Chunker: {
            CharChunker: {
                chunk_length: 200,
                sliding_window_size: 0.1,
                chunker_name: "char_chunker_"
            },
            SentChunker: {
                chunk_length: 5,
                sliding_window_size: 0.3,
                chunker_name: "sent_chunker_"
            }
        },
        Ranker: {
            TfidfRanker: {
                top_k: 4,
                ranker_name: "tfidf_ranker_"
            },
            SentEmbeddingRanker: {
                top_k: 5,
                ranker_name: "sent_embedding_ranker_"
            },
            GuessSimilarityRanker: {
                top_k: 3,
                ranker_name: "guess_similarity_ranker_"
            }
        },
        QA: {
            MistralQA: {
                model_name: "mistral_qa_"
            },
            GptQA: {
                model_name: "gpt_qa_"
            },
            LlamaQA: {
                model_name: "llama_qa_"
            }
        }
    };

    let customValues = {
        Chunker: {},
        Ranker: {},
        QA: {}
    };

    function addTextDocumentComponent(componentData = null) {
    let fileName = componentData ? componentData.fileName : '';
    let filePath = componentData ? componentData.filePath : '';
    let question = componentData ? componentData.question : '';

    const html = `
        <div class="card-wrapper">
            <div class="card mb-3 compact">
                <div class="card-header component-title">Text Document ${TextDocumentIndexCount + 1}</div>
                <div class="card-body">
                    <input type="file" name="ExperimentTextDocument_file_${TextDocumentIndexCount}" class="form-control mb-2" accept=".txt" value="${fileName}">
                    <input type="text" name="ExperimentTextDocument_file_path_${TextDocumentIndexCount}" placeholder="File path" class="form-control mb-2" value="${filePath}">
                    <input type="text" name="ExperimentTextDocument_question_${TextDocumentIndexCount}" placeholder="Question" class="form-control mb-2" value="${question}">
                    <input type="checkbox" class="deletable-component form-check-input mb-2" name="delete_ExperimentTextDocument_${TextDocumentIndexCount}" value="delete"> Delete
                </div>
            </div>
        </div>
    `;
    $('#ExperimentTextDocument').append(html);
    TextDocumentIndexCount++;
}

    function addNewsQADocumentComponent() {
        const html = `
    <div class="card-wrapper">
        <div class="card mb-3 compact">
            <div class="card-header component-title">NewsQA Document ${NewsQADocumentIndexCount + 1}</div>
            <div class="card-body">
                <input type="text" name="ExperimentNewsQaDocument_story_id_${NewsQADocumentIndexCount}" placeholder="story_id" class="form-control mb-2">
                <input type="checkbox" class="deletable-component form-check-input mb-2" name="delete_ExperimentTextDocument_${NewsQADocumentIndexCount}" value="delete"> Delete
            </div>
        </div>
    </div>
  `;
        $('#ExperimentTextDocument').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        NewsQADocumentIndexCount++;
    }

    function addChunkerComponent() {
        const html = `
    <div class="card-wrapper">
        <div class="card mb-3 compact">
            <div class="card-header component-title">Chunker ${ChunkerIndexCount + 1}</div>
            <div class="card-body">
                <select name="ExperimentChunker_chunker_type_${ChunkerIndexCount}" class="form-select mb-2">
                    <option value="CharChunker" selected="">CharChunker</option>
                    <option value="SentChunker">SentChunker</option>
                </select>
                <input type="number" name="ExperimentChunker_chunk_length_${ChunkerIndexCount}" value=200 placeholder="Chunk Length" class="form-control mb-2">
                <input type="text" name="ExperimentChunker_sliding_window_size_${ChunkerIndexCount}" value=0.3 placeholder="Sliding Window Size" class="form-control mb-2">
                <input type="text" name="ExperimentChunker_chunker_name_${ChunkerIndexCount}" value="chunker_${ChunkerIndexCount}" placeholder="Chunker Name" class="form-control mb-2">
                <input type="checkbox" class="deletable-component form-check-input mb-2" name="delete_ExperimentChunker_${ChunkerIndexCount}" value="delete"> Delete
            </div>
        </div>
    </div>
  `;
        $('#ExperimentChunker').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        ChunkerIndexCount++;
    }

    function addRankerComponent() {
        const html = `
    <div class="card-wrapper">
        <div class="card mb-3 compact">
            <div class="card-header component-title">Ranker ${RankerIndexCount + 1}</div>
            <div class="card-body">
                <select name="ExperimentRanker_ranker_type_${RankerIndexCount}"  class="form-select mb-2">
                    <option value="TfidfRanker" selected="">TfidfRanker</option>
                    <option value="SentEmbeddingRanker">SentEmbeddingRanker</option>
                    <option value="GuessSimilarityRanker">GuessSimilarityRanker</option>
                </select>
                <input type="number" name="ExperimentRanker_top_k_${RankerIndexCount}" value=3 placeholder="Top K" class="form-control mb-2">
                <input type="text" name="ExperimentRanker_ranker_name_${RankerIndexCount}" value="ranker_${RankerIndexCount}" placeholder="Ranker Name" class="form-control mb-2">
                <input type="checkbox" class="deletable-component form-check-input mb-2" name="delete_ExperimentRanker_${RankerIndexCount}" value="delete"> Delete
            </div>
        </div>
    </div>
  `;
        $('#ExperimentRanker').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        RankerIndexCount++;
    }

    function addQAComponent() {
        const html = `
    <div class="card mb-3 compact">
        <div class="card-header component-title">QA ${QAIndexCount + 1}</div>
        <div class="card-body">
            <select name="ExperimentQA_model_type_${QAIndexCount}" class="form-select mb-2">
                <option value="MistralQA" selected="">MistralQA</option>
                <option value="GptQA">GptQA</option>
                <option value="LlamaQA">LlamaQA</option>
            </select>
            <input type="text" name="ExperimentQA_model_name_${QAIndexCount}" value="qa_${QAIndexCount}" placeholder="Model Name" class="form-control mb-2">
            <input type="checkbox" class="deletable-component form-check-input mb-2" name="delete_ExperimentQA_${QAIndexCount}" value="delete"> Delete
        </div>
    </div>
  `;
        $('#ExperimentQA').append(html);
        $('input[type="checkbox"].deletable-component').on('click', deleteComponent);
        QAIndexCount++;
    }

    function deleteComponent() {
        $(this).closest('.card-wrapper').remove();
    }
    
    

    $(document).ready(function () {
        // For existing elements, update their classes
        $('input[type="text"], input[type="file"], input[type="number"], select').addClass('form-control mb-2');
        $('input[type="checkbox"]').addClass('form-check-input mb-2');
        $('input[type="select"]').addClass('form-select mb-2');
        $('label').addClass('form-check-label');

        // Your existing functions to add components go here
        $(document).on('wheel', '.form-select', function(e) {
        
            let select = $(this);
                let selectedIndex = select.prop('selectedIndex');
                let scrollDirection = e.originalEvent.deltaY;
        
                if (scrollDirection < 0) {
                    // Scroll up
                    if (selectedIndex > 0) {
                        select.prop('selectedIndex', selectedIndex - 1).change();
                    }
                } else {
                    // Scroll down
                    if (selectedIndex < select.children('option').length - 1) {
                        select.prop('selectedIndex', selectedIndex + 1).change();
                    }
                }
        
                // Prevent page from scrolling
                // e.preventDefault();
        });
            
        $(document).on('change', '.form-select', function() {
            let select = $(this);
            let selectedValue = select.val();
            let index = select.attr('name').match(/\d+$/)[0];
            
            const componentMapping = {
                Chunker: {
                    match: select.attr('name').match(/Chunker_(.+)_\d+/),
                    fields: ['chunk_length', 'sliding_window_size', 'chunker_name'],
                    prefix: 'ExperimentChunker',
                },
                Ranker: {
                    match: select.attr('name').match(/Ranker_(.+)_\d+/),
                    fields: ['top_k', 'ranker_name'],
                    prefix: 'ExperimentRanker',
                },
                QA: {
                    match: select.attr('name').match(/QA_(.+)_\d+/),
                    fields: ['model_name'],
                    prefix: 'ExperimentQA',
                },
            };
        
            Object.keys(componentMapping).forEach((compType) => {
                let comp = componentMapping[compType];
                if (comp.match && comp.match[1] === compType.toLowerCase() + '_type') {
                    if (!customValues[compType][index]) {
                        customValues[compType][index] = {};
                    }
                    
                    updateInputValues(comp, compType, selectedValue, index);
                }
            });
        });
        
        $(document).on('input', 'input', function() {
            let input = $(this);
            let inputName = input.attr('name');
            let index = inputName.match(/\d+$/)[0];
            
            const componentDetails = [
                { type: 'Chunker', regex: /(ExperimentChunker)_(.+)_\d+$/ },
                { type: 'Ranker', regex: /(ExperimentRanker)_(.+)_\d+$/ },
                { type: 'QA', regex: /(ExperimentQA)_(.+)_\d+$/ },
            ];
        
            componentDetails.forEach((compDetail) => {
                let match = inputName.match(compDetail.regex);
                if (match) {
                    let fieldType = match[2];
                    let compType = match[1].split('Experiment')[1];
                    let selector = $(`select[name="${compDetail.type}_${compType.toLowerCase()}_type_${index}"]`).val();
        
                    if (!customValues[compDetail.type][index]) {
                        customValues[compDetail.type][index] = {};
                    }
                    
                    if (!customValues[compDetail.type][index][selector]) {
                        customValues[compDetail.type][index][selector] = {};
                    } 
                    
                    customValues[compDetail.type][index][selector][fieldType] = input.val();
                    console.log(customValues);
                }
            });
        });
                    
        function updateInputValues(comp, compType, selectedValue, index) {
            comp.fields.forEach(field => {
                let inputName = `${comp.prefix}_${field}_${index}`;
                let input = $(`input[name="${inputName}"]`);
                let newValue = defaultValues[compType][selectedValue][field];
                
                if (field.includes('_name')) {
                    newValue += index;
                }
        
                if (!customValues[compType][index][selectedValue] || !customValues[compType][index][selectedValue][field]) {
                    input.val(newValue);
                } else {
                    input.val(customValues[compType][index][selectedValue][field]);
                }
            });
        }
    });
</script>

</body>
</html>